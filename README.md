# SMJEPG
A simple JEPG decoder.

MJPEG是一种基于静态图像JPEG压缩标准的动态图像压缩标准，压缩过程是将视频序列的每一帧视为一幅静止图像进行压缩。因此，要进行MJPEG压缩，首先必须实现静态图像的JPEG压缩。JPEG定义了两种基本的算法：基于DCT的有失真压缩算法和基于DPCM的无失真压缩算法。基于DCT的有失真JPEG压缩算法主要分为5个基本步骤：色彩空间变换及采样、离散余弦变换DCT、量化、Z字形编排、编码。

JPEG是一种很灵活的格式，具有调节图像质量的功能，允许用不同的压缩比例对文件进行压缩，支持多种压缩级别。压缩比越大，品质就越低。

JPEG委员会在制定JPEG标准时，定义了许多标记码(marker)或标记段(marker segments)组成，用来区分和识别图像数据及其相关信息。目前，使用比较广泛的是其交换格式JFIF(Jpeg File Interchange Format)。JPEG的每个标记码都是由2个字节组成，其前一个字节是固定值0xFF，每个标记码之前还可以添加数目不限的0xFF填充字节。JPEG文件中的字节是按照正序排列的，即高位字节在前，低位字节在后。

JFIF即JPEG文件交换格式(JPEG File Interchange Format, JFIF)是一个图像文件格式标准。它是一种交换符合JPEG交换格式(JIF)标准的JPEG编码文件的格式。它解决了JIF在简单JPEG编码文件交换方面的一些限制。与所有符号JIF的文件一样，JFIF文件中的图像数据使用JPEG标准的技术压缩，因此JFIF有时被称为”JPEG/JFIF”。在JFIF中，图像样本的存放顺序是从左到右和从上到下。

按照JFIF，JPEG文件由两个部分组成：文件头部分和图像压缩数据。其中文件头部分分为一个一个的段来存储(但并不是全部都是段)，段的多少和长度并不确定。只要包含了足够的信息，该JPEG文件就能够被打开。文件头部分的每个段都一定包含两部分，一个是段的标记码，它由两个字节构成：第一个字节是十六进制0xFF,第二个字节对于不同的段，有不同的值。紧接着的两个字节存放的是这个段的长度。这个长度的表示方法是按照高位在前，低位在后。另外，为了避免文件头部分和图像压缩数据部分的冲突，在对图像数据进行huffman编码时如果产生了一个0xFF，那么就用0xFF 0x00代替。因此在对压缩数据部分进行解码时，如果一个0xFF的后面字节不是0x00，那么这个字节没有意义，如果0xFF后一字节为0x00，则将此两个字节作为一个字节0xFF进行处理。由于文件头中包含了解码图像时必须的量化表、Huffman表、图像格式等信息，因此输出的第一帧JPEG数据流必须包含文件头。由于接下来编码的图像都是按照相同的方式进行编码的，因此可以不包含文件头，只需要在编码结束时产生一个表示编码结束的标记，用于区分不同帧图像，解码时在图像头部添加上文件头，将编码图像转变为标准的JPEG图像即可。


| 标记码 | 数值 | 描述|
| --- | --- | --- |
| SOI(start of image) | FFD8 |图像开始 |
| EOI(end of image) | FFD9|图像结束 |
| DQT(define quantization table)) | FFDB |量化表，可有多个 |
| SOF(start of frame) | FFC0 |一帧图像的开始,C0后的第4,5两个字节表示图像高度；第6,7两个字节表示图像宽度；第8个字节若为1则表示为灰度图，若为3则表示为彩色图 |
| DHT(define Huffman table) | FFC4 |Huffman表，可有多个 |
| APP0(application) | FFE0 |JFIF应用数据块，必须紧随SOI标记 |


JFIF APP0标记段：在强制性JFIF APP0标记段中指定图像的参数，可选嵌入未压缩的缩略图。
| 字段 | 大小 | 描述|
| --- | --- | --- |
|APP0标记 |2 |FF E0|
|长度|2|APP0段外的段长度|
|标识符|5|	4A 46 49 46 00 =”JFIF”的ASCII码，以空字节终止，注：在MJPEG中为41 56 49 31 00 =”AVI1”|
|JFIF版本|2|第一个字节为主版本，第二个字节为次要版本(01 01表示1.01)|
|密度单位|1|下列像素密度字段的单位：00：无单位;width:height像素宽高比=Xdensity:Ydensity01：每英寸像素(2.54厘米)02：每厘米像素|
|Xdensity|2|水平像素密度，不得为零|
|Ydensity|2|垂直像素密度，不得为零|
|Xthumbnail|1|嵌入的RGB缩略图的水平像素数，可以为零|
|Ythumbnail|1|嵌入的RGB缩略图的垂直像素数，可以为零|
|缩略图数据|3*n|	未压缩的24位RGB(每个颜色通道8位)光栅缩略图数据，顺序为R0、G0、B0、…Rn、Gn、Bn；其中n= Xthumbnail* Ythumbnail|


|源图像|---〉|正离散余弦变换|-->|量化|--〉|编码（常用霍夫曼编码）|--〉|JPEG图像|
                （FDCT）    （自建量化表）      （自建编码表）


|JPEG图像|--〉|解码|--〉|逆量化|------〉|反离散余弦变换|--〉|原图像|
       （使用编码时对应的编码表，量化表）    （IDCT）



关于huffman表和量化表可以查看：
https://blog.csdn.net/fzh2712/article/details/28318715
https://www.jianshu.com/p/43f34bceef9a
